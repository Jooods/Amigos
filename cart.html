<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Cart - Amigo Clothing</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 3rem auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      padding: 2rem;
    }
    h1 {
      text-align: center;
      color: #e74c3c;
      margin-bottom: 2rem;
    }
    .cart-list {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
    }
    .cart-list th, .cart-list td {
      padding: 1rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .cart-list th {
      color: #764ba2;
      font-size: 1.1rem;
    }
    .cart-list img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      border-radius: 8px;
      background: #fafafa;
    }
    .cart-empty {
      text-align: center;
      color: #888;
      font-size: 1.2rem;
      margin: 2rem 0;
    }
    .total-row td {
      font-weight: bold;
      font-size: 1.2rem;
      color: #e74c3c;
    }
    .cta-button {
      background: #e74c3c;
      color: white;
      padding: 0.9rem 2rem;
      border: none;
      border-radius: 5px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-top: 1rem;
      display: block;
      width: 100%;
    }
    .cta-button:hover {
      background: #c0392b;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 1.5rem;
      color: #764ba2;
      text-decoration: none;
      font-weight: 500;
      font-size: 1.1rem;
      transition: color 0.2s;
    }
    .back-link:hover {
      color: #e74c3c;
      text-decoration: underline;
    }
    @media (max-width: 700px) {
      .container { padding: 1rem; }
      .cart-list th, .cart-list td { padding: 0.5rem 0.2rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Shop</a>
    <h1>My Cart</h1>
    <div id="cart-content">
      <div style="text-align:center;color:#888;">Loading...</div>
    </div>
  </div>
  <!-- Checkout Modal -->
  <div id="checkout-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:3000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:2rem 2rem 1.5rem 2rem;border-radius:10px;max-width:350px;width:90vw;box-shadow:0 5px 20px rgba(0,0,0,0.2);position:relative;max-height:90vh;overflow-y:auto;">
      <button id="close-checkout-modal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.2rem;cursor:pointer;">&times;</button>
      <h2 style="text-align:center;color:#e74c3c;margin-bottom:1rem;">Select Payment Method</h2>
      <div style="display:flex;flex-direction:column;gap:1rem;">
        <button class="cta-button" id="cod-btn" style="background:#27ae60;">Cash on Delivery (COD)</button>
        <button class="cta-button" id="online-btn" style="background:#764ba2;">Online Payment <span style='font-size:0.95em;color:#27ae60;'>(fast delivery)</span></button>
      </div>
    </div>
  </div>
  <!-- Gcash Modal -->
  <div id="gcash-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:3100;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:2rem 2rem 1.5rem 2rem;border-radius:10px;max-width:350px;width:90vw;box-shadow:0 5px 20px rgba(0,0,0,0.2);position:relative;max-height:90vh;overflow-y:auto;">
      <button id="close-gcash-modal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.2rem;cursor:pointer;">&times;</button>
      <h2 style="text-align:center;color:#764ba2;margin-bottom:1rem;">Gcash Payment</h2>
      <div style="margin-bottom:1rem;text-align:center;">
        <div style="font-size:1.1rem;margin-bottom:0.5rem;"><strong>Gcash Number:</strong> 09454900399</div>
        <div style="font-size:1.1rem;margin-bottom:0.5rem;"><strong>Name:</strong> PETER JOEDALE J. DALING</div>
        <div style="font-size:1rem;color:#888;margin-bottom:1rem;">Send your payment proof to <strong>kalamasiledoj@gmail.com</strong></div>
        <button class="cta-button" id="send-gmail-btn" style="background:#e74c3c;">Send Proof via Gmail</button>
      </div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="firebase-config.mv"></script>
  <script>
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const cartContent = document.getElementById('cart-content');

    function renderCart(cartItems) {
      if (!cartItems || cartItems.length === 0) {
        cartContent.innerHTML = '<div class="cart-empty">Your cart is empty.</div>';
        return;
      }
      let html = '<form id="cart-form"><table class="cart-list">';
      html += '<tr><th></th><th>Product</th><th>Name</th><th>Price</th><th>Qty</th><th>Subtotal</th><th></th></tr>';
      cartItems.forEach((item, idx) => {
        const price = parseFloat(item.price) || 0;
        const qty = parseInt(item.quantity) || 1;
        const subtotal = price * qty;
        html += `<tr data-idx="${idx}">
          <td><input type="checkbox" class="select-item" checked></td>
          <td><img src="${(item.images && item.images[0]) || 'https://via.placeholder.com/60?text=No+Image'}" alt="${item.name}"></td>
          <td>${item.name}</td>
          <td>P${price.toFixed(2)}</td>
          <td>
            <button type="button" class="qty-btn" data-action="decrease">-</button>
            <span class="qty-val">${qty}</span>
            <button type="button" class="qty-btn" data-action="increase">+</button>
          </td>
          <td>P${subtotal.toFixed(2)}</td>
          <td><button type="button" class="delete-btn" title="Remove"><i class="fas fa-trash"></i></button></td>
        </tr>`;
      });
      html += '</table>';
      html += '<div id="cart-total" style="text-align:right;font-weight:bold;font-size:1.2rem;color:#e74c3c;margin-bottom:1rem;">Total: P0.00</div>';
      html += '<button class="cta-button" id="checkout-btn" type="submit">Checkout Selected</button>';
      html += '</form>';
      cartContent.innerHTML = html;

      function updateTotal() {
        const checkboxes = document.querySelectorAll('.select-item');
        let total = 0;
        checkboxes.forEach((cb, i) => {
          if (cb.checked) {
            const price = parseFloat(cartItems[i].price) || 0;
            const qty = parseInt(cartItems[i].quantity) || 1;
            total += price * qty;
          }
        });
        document.getElementById('cart-total').textContent = 'Total: P' + total.toFixed(2);
      }
      // Initial total
      updateTotal();
      // Update total on checkbox or quantity change
      document.querySelectorAll('.select-item').forEach(cb => {
        cb.addEventListener('change', updateTotal);
      });
      document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', () => setTimeout(updateTotal, 0));
      });

      // Quantity controls
      document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.onclick = async function() {
          const tr = btn.closest('tr');
          const idx = parseInt(tr.getAttribute('data-idx'));
          let newQty = cartItems[idx].quantity;
          if (btn.dataset.action === 'increase') newQty++;
          if (btn.dataset.action === 'decrease' && newQty > 1) newQty--;
          cartItems[idx].quantity = newQty;
          await updateCart(cartItems);
          renderCart(cartItems);
        };
      });
      // Delete controls
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = async function() {
          const tr = btn.closest('tr');
          const idx = parseInt(tr.getAttribute('data-idx'));
          cartItems.splice(idx, 1);
          await updateCart(cartItems);
          renderCart(cartItems);
        };
      });
      // Checkout selected
      document.getElementById('cart-form').onsubmit = function(e) {
        e.preventDefault();
        const selected = Array.from(document.querySelectorAll('.select-item')).map((cb, i) => cb.checked ? cartItems[i] : null).filter(Boolean);
        if (selected.length === 0) {
          alert('Please select at least one product to checkout.');
          return;
        }
        // Show checkout modal
        window.selectedCheckoutItems = selected;
        document.getElementById('checkout-modal').style.display = 'flex';
      };
    }

    async function updateCart(items) {
      const user = auth.currentUser;
      if (!user) return;
      await db.collection('cart').doc(user.uid).set({ items, userId: user.uid }, { merge: true });
    }

    function promptLogin() {
      cartContent.innerHTML = '<div class="cart-empty">Please <a href="index.html" style="color:#e74c3c;">log in</a> to view your cart.</div>';
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user || !user.emailVerified) {
        promptLogin();
        return;
      }
      // Fetch cart items from Firestore (collection 'cart', doc ID = user.uid, field 'items': array)
      const doc = await db.collection('cart').doc(user.uid).get();
      const cartItems = doc.exists && Array.isArray(doc.data().items) ? doc.data().items : [];
      renderCart(cartItems);
    });

    // Checkout modal logic
    const checkoutModal = document.getElementById('checkout-modal');
    const closeCheckoutModal = document.getElementById('close-checkout-modal');
    const codBtn = document.getElementById('cod-btn');
    const onlineBtn = document.getElementById('online-btn');
    closeCheckoutModal.onclick = function() { checkoutModal.style.display = 'none'; };
    checkoutModal.addEventListener('click', function(e) { if (e.target === checkoutModal) checkoutModal.style.display = 'none'; });

    // Gcash modal logic
    const gcashModal = document.getElementById('gcash-modal');
    const closeGcashModal = document.getElementById('close-gcash-modal');
    const sendGmailBtn = document.getElementById('send-gmail-btn');
    closeGcashModal.onclick = function() { gcashModal.style.display = 'none'; };
    gcashModal.addEventListener('click', function(e) { if (e.target === gcashModal) gcashModal.style.display = 'none'; });
    sendGmailBtn.onclick = function() {
      window.open('https://mail.google.com/mail/?view=cm&fs=1&to=kalamasiledoj@gmail.com&su=Gcash%20Payment%20Proof&body=I%20have%20sent%20my%20payment%20to%2009454900399%20(PETER%20JOEDALE%20J.%20DALING).%20Please%20see%20attached%20proof.', '_blank');
    };

    // Helper to move items to orders
    async function moveToPending(selected, typeShipping) {
      const user = auth.currentUser;
      if (!user) return;
      // Create a new pending document for each selected item
      for (const item of selected) {
        const { id, ...itemWithoutId } = item; // Remove id field for pending
        await db.collection('pending').add({
          ...itemWithoutId,
          userId: user.uid,
          status: 'pending',
          typeShipping,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      // Remove checked out items from cart (keep id in cart items!)
      const cartDoc = await db.collection('cart').doc(user.uid).get();
      let items = (cartDoc.exists && Array.isArray(cartDoc.data().items)) ? cartDoc.data().items : [];
      // Remove items that were checked out (by id)
      items = items.filter(item => !selected.some(sel => sel.id === item.id));
      await db.collection('cart').doc(user.uid).set({ items, userId: user.uid }, { merge: true });
      renderCart(items);
    }

    codBtn.onclick = async function() {
      checkoutModal.style.display = 'none';
      await moveToPending(window.selectedCheckoutItems, 'cod');
      alert('Order placed as Cash on Delivery!');
    };
    onlineBtn.onclick = async function() {
      checkoutModal.style.display = 'none';
      await moveToPending(window.selectedCheckoutItems, 'online payment');
      gcashModal.style.display = 'flex';
    };
  </script>
  <!-- Disable right-click and common dev tools shortcuts -->
  <script>
    (function() {
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        document.addEventListener('keydown', function(e) {
            // F12
            if (e.key === 'F12') {
                e.preventDefault();
            }
            // Ctrl+Shift+I or Ctrl+Shift+J or Ctrl+U
            if ((e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
                (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
            }
        });
    })();
  </script>
</body>
</html> 